<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Planner Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
<div id="map"></div>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Ensure the webview is available before using it
    if (window.chrome && window.chrome.webview) {
        console.log("Webview host detected.");
    } else {
        console.error("Webview host not detected.");
    }

    let map;
    let startMarker, endMarker;
    let routeLayer;

    // 1. Initialize the map
    function initMap() {
        map = L.map('map').setView([48.2082, 16.3738], 10); // Default to Vienna

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 2. Listen for map clicks
        map.on('click', onMapClick);
        console.log("Map initialized and click listener added.");
    }

    // 3. Handle map clicks and send coordinates to C#
    function onMapClick(e) {
        const coords = e.latlng;
        console.log(`Map clicked at: Lat ${coords.lat}, Lon ${coords.lng}`);

        // Send message to C# backend
        window.chrome.webview.postMessage({
            type: 'MapClick',
            lat: coords.lat,
            lon: coords.lng
        });
    }

    // 4. Function to add a marker (called from C#)
    function addMarker(lat, lon, type) {
        const marker = L.marker([lat, lon]);
        if (type === 'start') {
            if (startMarker) map.removeLayer(startMarker);
            startMarker = marker;
        } else if (type === 'end') {
            if (endMarker) map.removeLayer(endMarker);
            endMarker = marker;
        }
        marker.addTo(map);
        console.log(`Marker added at: Lat ${lat}, Lon ${lon}`);
    }

    // 5. Function to draw the route (called from C#)
    function drawRoute(geoJsonString) {
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }
        try {
            const geoJson = JSON.parse(geoJsonString);
            routeLayer = L.geoJSON(geoJson, {
                style: {
                    color: "#ff7800",
                    weight: 5,
                    opacity: 0.65
                }
            }).addTo(map);
            map.fitBounds(routeLayer.getBounds()); // Zoom to the route
            console.log("Route drawn successfully.");
        } catch (error) {
            console.error("Failed to parse or draw route:", error);
        }
    }

    // 6. Function to clear markers and route
    function clearMap() {
        if(startMarker) map.removeLayer(startMarker);
        if(endMarker) map.removeLayer(endMarker);
        if(routeLayer) map.removeLayer(routeLayer);
        startMarker = null;
        endMarker = null;
        routeLayer = null;
        console.log("Map cleared.");
    }

    // Initialize the map when the page loads
    document.addEventListener('DOMContentLoaded', initMap);
</script>
</body>
</html>